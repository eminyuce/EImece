DTO Refactoring Blueprint (Product -> ProductCategory -> BlogPost/Story)
====================================================================

1) ProductDetailViewModel (changed properties only)
---------------------------------------------------
Before:
public Product Product { get; set; }
public ProductComment ProductComment { get; set; }
public Menu ProductMenu { get; set; }
public Menu MainPageMenu { get; set; }
public Template Template { get; set; }
public List<Story> RelatedStories { get; set; }
public List<Product> RelatedProducts { get; set; }
public Setting CargoDescription { get; set; }
public Setting CargoPrice { get; set; }
public Setting IsProductPriceEnable { get; set; }
public Setting IsProductReviewEnable { get; set; }
public Setting WhatsAppCommunicationLink { get; set; }
public Setting CompanyName { get; set; }

After:
public ProductDto ProductDto { get; set; }
public ProductCommentDto ProductCommentDto { get; set; }
public MenuDto ProductMenuDto { get; set; }
public MenuDto MainPageMenuDto { get; set; }
public TemplateDto TemplateDto { get; set; }
public List<StoryDto> RelatedStoriesDto { get; set; }
public List<ProductDto> RelatedProductsDto { get; set; }
public SettingDto CargoDescriptionDto { get; set; }
public SettingDto CargoPriceDto { get; set; }
public SettingDto IsProductPriceEnableDto { get; set; }
public SettingDto IsProductReviewEnableDto { get; set; }
public SettingDto WhatsAppCommunicationLinkDto { get; set; }
public SettingDto CompanyNameDto { get; set; }

2) New ProductService method
----------------------------
public ProductDetailViewModel GetProductDetailForFrontById(int id)
{
    var product = GetProductById(id); // existing entity-returning method
    if (product == null) return null;

    var language = product.Lang;
    var productTags = product.ProductTags?.Select(t => t.Tag).ToList() ?? new List<Tag>();
    var relatedStories = productTags.Any()
        ? StoryRepository.GetRelatedStories(productTags.Select(t => t.Id).ToArray(), 10, language, 0)
        : new List<Story>();

    var relatedProducts = productTags.Any()
        ? ProductRepository.GetRelatedProducts(productTags.Select(t => t.Id).ToArray(), 10, language, product.Id)
        : new List<Product>();

    return new ProductDetailViewModel
    {
        ProductDto = _mapper.Map<ProductDto>(product),
        ProductCommentDto = new ProductCommentDto { ProductId = product.Id },
        ProductMenuDto = _mapper.Map<MenuDto>(MenuService.GetActiveBaseContentsFromCache(true, language)
            .FirstOrDefault(r => r.MenuLink.Equals("products-index", StringComparison.InvariantCultureIgnoreCase))),
        MainPageMenuDto = _mapper.Map<MenuDto>(MenuService.GetActiveBaseContentsFromCache(true, language)
            .FirstOrDefault(r => r.MenuLink.Equals("home-index", StringComparison.InvariantCultureIgnoreCase))),
        TemplateDto = product.ProductCategory?.Template != null ? _mapper.Map<TemplateDto>(product.ProductCategory.Template) : null,
        RelatedStoriesDto = _mapper.Map<List<StoryDto>>(relatedStories),
        RelatedProductsDto = _mapper.Map<List<ProductDto>>(relatedProducts),
        CargoDescriptionDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.CargoDescription)),
        CargoPriceDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.CargoPrice)),
        IsProductPriceEnableDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.IsProductPriceEnable)),
        IsProductReviewEnableDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.IsProductReviewEnable)),
        WhatsAppCommunicationLinkDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.WhatsAppCommunicationLink)),
        CompanyNameDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.CompanyName))
    };
}

3) Updated End-User Controller example
--------------------------------------
public ActionResult Detail(string id, int page = 1)
{
    var productId = id.GetId();
    var vm = ProductService.GetProductDetailForFrontById(productId);
    if (vm == null || vm.ProductDto == null || !vm.ProductDto.IsActive)
    {
        return RedirectToAction("NotFound", "Error");
    }

    vm.Page = page;
    vm.RecordPerPage = AppConfig.ProductCommentsRecordPerPage;
    vm.SeoId = id;

    return View(vm);
}

4) Minimal .cshtml illustration
-------------------------------
@model EImece.Domain.Models.FrontModels.ProductDetailViewModel
<h1>@Model.ProductDto.ProductNameStr</h1>

5) AutoMapper mappings
----------------------
// already in MappingProfile for most entities, add only if missing:
CreateMap<ProductComment, ProductCommentDto>();
CreateMap<Template, TemplateDto>();


1) ProductCategoryViewModel (changed properties only)
-----------------------------------------------------
Before:
public ProductCategory ProductCategory { get; set; }
public List<Product> CategoryChildrenProducts { get; set; }
public Menu ProductMenu { get; set; }
public Menu MainPageMenu { get; set; }
public List<ProductCategory> ChildrenProductCategories { get; set; }
public List<Brand> Brands { get; set; }
public Setting PriceFilterSetting { get; set; }
public List<Product> AllProducts { get; set; }

After:
public ProductCategoryDto ProductCategoryDto { get; set; }
public List<ProductDto> CategoryChildrenProductsDto { get; set; }
public MenuDto ProductMenuDto { get; set; }
public MenuDto MainPageMenuDto { get; set; }
public List<ProductCategoryDto> ChildrenProductCategoriesDto { get; set; }
public List<BrandDto> BrandsDto { get; set; }
public SettingDto PriceFilterSettingDto { get; set; }
public List<ProductDto> AllProductsDto { get; set; }

2) New ProductCategoryService method
------------------------------------
public ProductCategoryViewModel GetProductCategoryForFront(int productCategoryId)
{
    var category = GetProductCategory(productCategoryId);
    if (category == null) return null;

    if (category.ParentId > 0)
    {
        category.Parent = GetProductCategory(category.ParentId);
        if (category.Parent?.ParentId > 0)
        {
            category.Parent.Parent = GetProductCategory(category.Parent.ParentId);
        }
    }

    var lang = category.Lang;
    var menus = MenuService.GetActiveBaseContentsFromCache(true, lang);
    var children = ProductCategoryRepository.GetProductCategoriesByParentId(productCategoryId);
    var childrenProducts = ProductService.GetChildrenProducts(category, children);

    return new ProductCategoryViewModel
    {
        ProductCategoryDto = _mapper.Map<ProductCategoryDto>(category),
        CategoryChildrenProductsDto = _mapper.Map<List<ProductDto>>(childrenProducts),
        ProductMenuDto = _mapper.Map<MenuDto>(menus.FirstOrDefault(m => m.MenuLink.Equals("products-index", StringComparison.InvariantCultureIgnoreCase))),
        MainPageMenuDto = _mapper.Map<MenuDto>(menus.FirstOrDefault(m => m.MenuLink.Equals("home-index", StringComparison.InvariantCultureIgnoreCase))),
        ChildrenProductCategoriesDto = _mapper.Map<List<ProductCategoryDto>>(children),
        BrandsDto = _mapper.Map<List<BrandDto>>(BrandService.GetBrandsIfAnyProductExists(lang)),
        ProductCategoryTree = BuildTree(true, lang),
        PriceFilterSettingDto = _mapper.Map<SettingDto>(SettingService.GetSettingObjectByKey(Constants.ProductPriceFilterSetting))
    };
}

3) Updated End-User Controller example
--------------------------------------
public ActionResult Category(string id, int page = 1)
{
    var categoryId = id.GetId();
    var vm = ProductCategoryService.GetProductCategoryForFront(categoryId);
    if (vm == null || vm.ProductCategoryDto == null)
    {
        return RedirectToAction("NotFound", "Error");
    }

    vm.Page = page;
    vm.SeoId = id;
    return View(vm);
}

4) Minimal .cshtml illustration
-------------------------------
@model EImece.Domain.Models.FrontModels.ProductCategoryViewModel
<h1>@Model.ProductCategoryDto.Name</h1>

5) AutoMapper mappings
----------------------
CreateMap<Brand, BrandDto>();
CreateMap<Menu, MenuDto>();
CreateMap<Setting, SettingDto>();


1) StoryDetailViewModel / StoryIndexViewModel (changed properties only)
------------------------------------------------------------------------
Before:
public Story Story { get; set; }
public List<StoryCategory> StoryCategories { get; set; }
public List<Story> RelatedStories { get; set; }
public List<Story> FeaturedStories { get; set; }
public List<Product> RelatedProducts { get; set; }
public Menu BlogMenu { get; set; }
public Menu MainPageMenu { get; set; }
public List<Tag> Tags { get; set; }
public Story PreviousStory { get; set; }
public Story NextStory { get; set; }

public PaginatedList<Story> Stories { get; set; }
public List<StoryCategory> StoryCategories { get; set; }

After:
public StoryDto StoryDto { get; set; }
public List<StoryCategoryDto> StoryCategoriesDto { get; set; }
public List<StoryDto> RelatedStoriesDto { get; set; }
public List<StoryDto> FeaturedStoriesDto { get; set; }
public List<ProductDto> RelatedProductsDto { get; set; }
public MenuDto BlogMenuDto { get; set; }
public MenuDto MainPageMenuDto { get; set; }
public List<TagDto> TagsDto { get; set; }
public StoryDto PreviousStoryDto { get; set; }
public StoryDto NextStoryDto { get; set; }

public PaginatedList<StoryDto> StoriesDto { get; set; }
public List<StoryCategoryDto> StoryCategoriesDto { get; set; }

2) New StoryService methods
---------------------------
public StoryDetailViewModel GetStoryDetailForFront(int storyId)
{
    var story = GetStoryById(storyId);
    if (story == null) return null;

    var language = story.Lang;
    var tagIds = story.StoryTags?.Select(t => t.TagId).ToArray() ?? Array.Empty<int>();

    var relatedStories = tagIds.Any() ? StoryRepository.GetRelatedStories(tagIds, 10, language, storyId) : new List<Story>();
    var relatedProducts = tagIds.Any() ? ProductRepository.GetRelatedProducts(tagIds, 10, language, 0) : new List<Product>();

    return new StoryDetailViewModel
    {
        StoryDto = _mapper.Map<StoryDto>(story),
        StoryCategoriesDto = _mapper.Map<List<StoryCategoryDto>>(StoryCategoryService.GetActiveStoryCategories(language)),
        RelatedStoriesDto = _mapper.Map<List<StoryDto>>(relatedStories),
        FeaturedStoriesDto = _mapper.Map<List<StoryDto>>(StoryRepository.GetFeaturedStories(10, language, storyId)),
        RelatedProductsDto = _mapper.Map<List<ProductDto>>(relatedProducts),
        MainPageMenuDto = _mapper.Map<MenuDto>(MenuService.GetActiveBaseContentsFromCache(true, language)
            .FirstOrDefault(m => m.MenuLink.Equals("home-index", StringComparison.InvariantCultureIgnoreCase))),
        BlogMenuDto = _mapper.Map<MenuDto>(MenuService.GetActiveBaseContentsFromCache(true, language)
            .FirstOrDefault(m => m.MenuLink.Equals("stories-categories_" + story.GetSeoUrl(), StringComparison.InvariantCultureIgnoreCase))),
        TagsDto = _mapper.Map<List<TagDto>>(TagService.GetActiveBaseEntities(true, language)),
        PreviousStoryDto = _mapper.Map<StoryDto>(StoryRepository.GetPreviousStory(storyId, language)),
        NextStoryDto = _mapper.Map<StoryDto>(StoryRepository.GetNextStory(storyId, language))
    };
}

public StoryIndexViewModel GetMainPageStoriesForFront(int page, int language)
{
    int pageSize = AppConfig.RecordPerPage;
    var storiesEntity = StoryRepository.GetMainPageStories(page, pageSize, language);

    var storyDtoItems = _mapper.Map<List<StoryDto>>(storiesEntity.ToList());
    var storiesDto = new PaginatedList<StoryDto>(storyDtoItems, storiesEntity.PageIndex, storiesEntity.PageSize, storiesEntity.TotalCount);

    return new StoryIndexViewModel
    {
        StoriesDto = storiesDto,
        StoryCategoriesDto = _mapper.Map<List<StoryCategoryDto>>(StoryCategoryService.GetActiveStoryCategories(language))
    };
}

3) Updated End-User Controller example
--------------------------------------
public ActionResult Detail(string id)
{
    var storyId = id.GetId();
    var vm = StoryService.GetStoryDetailForFront(storyId);
    if (vm == null || vm.StoryDto == null) return RedirectToAction("NotFound", "Error");
    return View(vm);
}

public ActionResult Index(int page = 1)
{
    var vm = StoryService.GetMainPageStoriesForFront(page, CurrentLanguage);
    return View(vm);
}

4) Minimal .cshtml illustration
-------------------------------
@model EImece.Domain.Models.FrontModels.StoryDetailViewModel
<h1>@Model.StoryDto.Name</h1>

@model EImece.Domain.Models.FrontModels.StoryIndexViewModel
@foreach (var story in Model.StoriesDto) { <h2>@story.Name</h2> }

5) AutoMapper mappings
----------------------
CreateMap<Story, StoryDto>();
CreateMap<StoryCategory, StoryCategoryDto>();
CreateMap<Tag, TagDto>();
