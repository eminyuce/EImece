@using EImece.Domain.Models.FrontModels;
@using EImece.Domain.Entities;
@using EImece.Domain.Helpers.HtmlHelpers;
@using EImece.Domain.Helpers.Extensions;
@using EImece.Domain.Helpers;
@using EImece.Domain;
@using Resources;
@model  ShoppingCartSession

@{
    ViewBag.Title = "ShoppingCart";
    var products = Model.ShoppingCartItems;
}

<section class="titlebar">
    <div class="container">
        <div class="sixteen columns">
            <h2>Shopping Cart</h2>

            <nav id="breadcrumbs">
                <ul>
                    <li><a href="#">Home</a></li>
                    <li>Shopping Cart</li>
                </ul>
            </nav>
        </div>
    </div>
</section>
<div class="container cart">

    <div class="sixteen columns">



        <table class="cart-table responsive-table stacktable large-only">
            <tbody>
                <tr>
                    <th>Item</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th></th>
                </tr>


                @if (!products.IsNullOrEmpty())
                {
                    for (int i = 0; i < products.Count; i++)
                    {
                        var item = products[i];
                        var product = item.product;
                        double totalPricePerItem = product.Price * item.quantity;

                        <tr>
                            <td>
                                <input type="hidden" name=@String.Format("productId[{0}]", i) value="@item.product.Id">
                                @if (product.MainImageId.HasValue && product.ImageState)
                                {
                                    <img class="rsImg" src="@product.GetCroppedImageUrl(product.MainImageId.Value, 80, 80)" alt="" />
                                }
                            </td>
                            <td class="cart-title"><a href="@Url.Action("Detail","Products",new { id=product.Id })">@product.Name</a></td>
                            <td>
                                <input type="hidden" data-shopping-item-price="@item.ShoppingCartItemId" value="@product.Price" />
                                <span> @product.Price.CurrencySign()</span>

                            </td>
                            <td>
                                <input type="text" name=@String.Format("quantity[{0}]", i)
                                       data-shopping-quantity-id="@item.ShoppingCartItemId"
                                       value="@item.quantity" autocomplete='off'
                                       class="qty">
                            </td>
                            <td class="cart-total"><span data-shopping-item-total-price="@item.ShoppingCartItemId"  > @totalPricePerItem.CurrencySign()</span></td>
                            <td><a href="@Url.Action("RemoveCart",new { id=item.product.Id })" class="cart-remove"></a></td>
                        </tr>
                    }
                }

            </tbody>
        </table>

        <!-- Apply Coupon Code / Buttons -->
        <table class="cart-table bottom">

            <tbody>
                <tr>
                    <th>
                        <div class="cart-btns">
                            <a href="@Url.Action("CheckoutBillingDetails")" class="button color cart-btns proceed">Proceed to Checkout</a>
                            <a id="test2" href="#" class="button gray cart-btns">Update Cart</a>
                        </div>
                    </th>
                </tr>

            </tbody>
        </table>
    </div>


    <!-- Cart Totals -->
    <div class="eight columns cart-totals">
        <h3 class="headline">Cart Totals</h3><span class="line"></span><div class="clearfix"></div>

        <table class="cart-table margin-top-5">

            <tbody>
                <tr>
                    <th>Cart Subtotal</th>
                    <td><strong>@Model.SubTotalPrice.CurrencySign()</strong></td>
                </tr>

                <tr>
                    <th>Shipping and Handling</th>
                    <td>Free Shipping</td>
                </tr>

                <tr>
                    <th>Order Total</th>
                    <td><strong>@Model.TotalPrice.CurrencySign()</strong></td>
                </tr>

            </tbody>
        </table>
        <br>
        <!-- <a href="#" class="calculate-shipping"><i class="fa fa-arrow-circle-down"></i> Calculate Shipping</a> -->
    </div>

</div>

@section Scripts{

    <script id="priceHtml" type="text/template">
        ₺{{totalPrice}},00
    </script>


    <script>
        $(document).ready(function () {
            console.log("jquery is working");
            bindOnChangeQuantity();
        });

        function bindOnChangeQuantity() {
            // $('[data-message-id] .full-text').slideUp();

            $('[data-shopping-quantity-id]').each(function () {
                $(this).off("blur");
                $(this).on("blur", function (e) {
                    var caller = e.target;
                    var shoppingItem = $(caller).attr('data-shopping-quantity-id');
                    console.log(shoppingItem);
                    var itemPrice = $('[data-shopping-item-price=' + shoppingItem + ']').val();
                    var totalPrice = parseFloat(itemPrice) * caller.value;
                    console.log(totalPrice);
                    var data = { totalPrice: totalPrice };
                    $('[data-shopping-item-total-price=' + shoppingItem + ']').html(Mustache.render($('#priceHtml').html(), data));
                });
            });
        }




    </script>
}